<!-- Add Listing Modal -->
<div class="modal" id="addListingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Service Listing</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="alert alert-danger" id="listingError"></div>
        <form id="addListingForm">
            <div class="form-group">
                <label for="listingTitle">Service Title</label>
                <input type="text" id="listingTitle" class="form-control" placeholder="e.g., Professional Web Development" required>
            </div>
            <div class="form-group">
                <label for="listingCategory">Category</label>
                <select id="listingCategory" class="form-control" required>
                    <option value="">Select a category</option>
                    <option value="Web Development">Web Development</option>
                    <option value="Graphic Design">Graphic Design</option>
                    <option value="Home Renovation">Home Renovation</option>
                    <option value="Personal Training">Personal Training</option>
                    <option value="Event Planning">Event Planning</option>
                    <option value="Photography">Photography</option>
                    <option value="Writing & Translation">Writing & Translation</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Consulting">Consulting</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="listingDescription">Description</label>
                <textarea id="listingDescription" class="form-control" rows="4" placeholder="Describe your service in detail..." required></textarea>
            </div>
            <div class="form-group">
                <label for="listingPrice">Price (£)</label>
                <input type="number" id="listingPrice" class="form-control" placeholder="e.g., 250" min="0" step="0.01" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Listing</button>
        </form>
    </div>
</div>

<!-- Edit Listing Modal -->
<div class="modal" id="editListingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Service Listing</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="alert alert-danger" id="editListingError"></div>
        <form id="editListingForm">
            <input type="hidden" id="editListingId">
            <div class="form-group">
                <label for="editListingTitle">Service Title</label>
                <input type="text" id="editListingTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editListingCategory">Category</label>
                <select id="editListingCategory" class="form-control" required>
                    <option value="">Select a category</option>
                    <option value="Web Development">Web Development</option>
                    <option value="Graphic Design">Graphic Design</option>
                    <option value="Home Renovation">Home Renovation</option>
                    <option value="Personal Training">Personal Training</option>
                    <option value="Event Planning">Event Planning</option>
                    <option value="Photography">Photography</option>
                    <option value="Writing & Translation">Writing & Translation</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Consulting">Consulting</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editListingDescription">Description</label>
                <textarea id="editListingDescription" class="form-control" rows="4" required></textarea>
            </div>
            <div class="form-group">
                <label for="editListingPrice">Price (£)</label>
                <input type="number" id="editListingPrice" class="form-control" min="0" step="0.01" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Update Listing</button>
        </form>
    </div>
</div>

<script>
// API Base URL - Update this with your Render URL
const API_BASE_URL = window.location.origin;

// DOM Elements
const addListingModal = document.getElementById('addListingModal');
const editListingModal = document.getElementById('editListingModal');
const addListingForm = document.getElementById('addListingForm');
const editListingForm = document.getElementById('editListingForm');
const addListingBtn = document.getElementById('addListingBtn');
const dashboardSection = document.getElementById('dashboardSection');
const dashboardContent = document.getElementById('dashboardContent');
const listingError = document.getElementById('listingError');
const editListingError = document.getElementById('editListingError');

// Event Listeners
if (addListingBtn) {
    addListingBtn.addEventListener('click', () => showModal(addListingModal));
}

addListingForm.addEventListener('submit', handleAddListing);
editListingForm.addEventListener('submit', handleEditListing);

// Functions
function showModal(modal) {
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    modal.style.display = 'flex';
}

function hideAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideAllModals();
        }
    });
});

// Close modals with close button
document.querySelectorAll('.close-modal').forEach(button => {
    button.addEventListener('click', hideAllModals);
});

// Add Listing
async function handleAddListing(e) {
    e.preventDefault();
    
    const title = document.getElementById('listingTitle').value;
    const category = document.getElementById('listingCategory').value;
    const description = document.getElementById('listingDescription').value;
    const price = document.getElementById('listingPrice').value;
    
    const token = localStorage.getItem('token');
    
    if (!token) {
        showError(listingError, 'Please log in to create listings');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/listings`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title, category, description, price })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Clear form and close modal
            addListingForm.reset();
            hideAllModals();
            
            // Reload listings
            loadUserListings();
            
            // Show success message
            alert('Listing created successfully!');
        } else {
            showError(listingError, data.message || 'Error creating listing');
        }
    } catch (error) {
        showError(listingError, 'Error creating listing. Please try again.');
        console.error('Error:', error);
    }
}

// Edit Listing
async function handleEditListing(e) {
    e.preventDefault();
    
    const id = document.getElementById('editListingId').value;
    const title = document.getElementById('editListingTitle').value;
    const category = document.getElementById('editListingCategory').value;
    const description = document.getElementById('editListingDescription').value;
    const price = document.getElementById('editListingPrice').value;
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/listings/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title, category, description, price })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Close modal and reload listings
            hideAllModals();
            loadUserListings();
            
            // Show success message
            alert('Listing updated successfully!');
        } else {
            showError(editListingError, data.message || 'Error updating listing');
        }
    } catch (error) {
        showError(editListingError, 'Error updating listing. Please try again.');
        console.error('Error:', error);
    }
}

// Load User Listings
async function loadUserListings() {
    const token = localStorage.getItem('token');
    
    if (!token) {
        dashboardContent.innerHTML = '<p>Please log in to view your listings.</p>';
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/listings/user/my-listings`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const listings = await response.json();
            displayListings(listings);
        } else {
            dashboardContent.innerHTML = '<p>Error loading your listings. Please try again.</p>';
        }
    } catch (error) {
        console.error('Error loading listings:', error);
        dashboardContent.innerHTML = '<p>Error loading your listings. Please try again.</p>';
    }
}

// Display Listings
function displayListings(listings) {
    if (listings.length === 0) {
        dashboardContent.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-clipboard-list" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
                <h3>No Listings Yet</h3>
                <p>Get started by adding your first service listing!</p>
                <button class="btn btn-primary" id="addFirstListingBtn">Add Your First Listing</button>
            </div>
        `;
        
        document.getElementById('addFirstListingBtn').addEventListener('click', () => {
            showModal(addListingModal);
        });
        
        return;
    }
    
    dashboardContent.innerHTML = `
        <div class="listings-grid">
            ${listings.map(listing => `
                <div class="listing-card" data-id="${listing._id}">
                    <div class="listing-header">
                        <h3>${listing.title}</h3>
                        <span class="listing-price">£${listing.price}</span>
                    </div>
                    <div class="listing-category">${listing.category}</div>
                    <p class="listing-description">${listing.description}</p>
                    <div class="listing-footer">
                        <span class="listing-date">Posted: ${new Date(listing.createdAt).toLocaleDateString()}</span>
                        <div class="listing-actions">
                            <button class="btn btn-outline edit-listing-btn" data-id="${listing._id}">Edit</button>
                            <button class="btn btn-danger delete-listing-btn" data-id="${listing._id}">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Add event listeners to action buttons
    document.querySelectorAll('.edit-listing-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            editListing(id);
        });
    });
    
    document.querySelectorAll('.delete-listing-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            deleteListing(id);
        });
    });
}

// Edit Listing
async function editListing(id) {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/listings/${id}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const listing = await response.json();
            
            // Populate edit form
            document.getElementById('editListingId').value = listing._id;
            document.getElementById('editListingTitle').value = listing.title;
            document.getElementById('editListingCategory').value = listing.category;
            document.getElementById('editListingDescription').value = listing.description;
            document.getElementById('editListingPrice').value = listing.price;
            
            // Show edit modal
            showModal(editListingModal);
        } else {
            alert('Error loading listing details');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading listing details');
    }
}

// Delete Listing
async function deleteListing(id) {
    if (!confirm('Are you sure you want to delete this listing?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/listings/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            // Reload listings
            loadUserListings();
            alert('Listing deleted successfully!');
        } else {
            const data = await response.json();
            alert(data.message || 'Error deleting listing');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting listing');
    }
}

// Show Error Message
function showError(element, message) {
    element.textContent = message;
    element.style.display = 'block';
    
    // Hide error after 5 seconds
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

// Load listings when dashboard is shown
if (dashboardSection) {
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (dashboardSection.style.display !== 'none') {
                    loadUserListings();
                }
            }
        });
    });
    
    observer.observe(dashboardSection, { attributes: true });
}

// Add some CSS for the listings
const listingStyles = `
    <style>
        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .listing-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .listing-card:hover {
            transform: translateY(-5px);
        }
        
        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .listing-header h3 {
            margin: 0;
            color: var(--dark);
        }
        
        .listing-price {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.2em;
        }
        
        .listing-category {
            background: var(--light);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .listing-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .listing-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .listing-date {
            color: #888;
            font-size: 0.9em;
        }
        
        .listing-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
`;

document.head.insertAdjacentHTML('beforeend', listingStyles);
</script>
